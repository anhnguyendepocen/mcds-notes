---
title: "Regression"
output: html_notebook
---

## Libraries

```{r setup}
library(ggplot2)
library(scales)
library(dplyr)
library(survival)
library(survminer)
library(lubridate)
library(tidyr)
library(stringr)
library(forcats)
library(wesanderson)
library(class)
library(rpart)
library(rpart.plot)
library(plotly)
```

## ESL Dataset

```{r}
load("../data/mixture.example.RData")
intercept = 50.0
coef_x1 = 10.0
coef_x2 = -0.0
set.seed(1000)
df <- data.frame(x1 = mixture.example$x[,1], 
                 x2 = mixture.example$x[,2]) %>%
  mutate(y = intercept + coef_x1 * x1 + coef_x2 * x2 + rnorm(length(x1), 0, 5))
x.grid <- seq(min(df$x1), max(df$x1), 0.1)
y.grid <- seq(min(df$x2), max(df$x2), 0.1)
hist(df$y)
```

Figure (just the dataset)

```{r}
xy.grid <- expand.grid(x.grid, y.grid)
names(xy.grid) <- c("x1", "x2")
p <- ggplot(df) + 
  geom_point(aes(x = x1, y = x2, colour = y, fill = y), pch = 21) + 
  geom_point(aes(x = x1, y = x2), alpha = 0.5, data = xy.grid, colour = "gray50", size = 0.02) + 
  theme_minimal() + 
  xlab("Disease Severity Score (x1)") + 
  ylab("Social Determinants Score (x2)") + 
  theme(axis.text = element_blank()) + 
  theme(legend.position = "bottom", panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + 
  scale_colour_gradient(name = "Recurrence\nBiomarker (ng/dL)", low = "#00bfc4", high = "#f8766d") + 
  scale_fill_gradient(name = "Recurrence\nBiomarker (ng/dL)", low = "#00bfc4", high = "#f8766d")
print(p)
ggsave(p, filename = "../img/esl-reg-just-data.png", height=4.5, width=4, units="in", dpi=300)
```

3D plot with KNN (K=15) as 3rd dimension

```{r}
p <- plot_ly(
  df, x = ~x1, y = ~x2, z = ~y, 
  color = ~y, colors = colorRamp(c("#00bfc4", "#f8766d"))) %>%
  add_markers() %>%
  layout(
    scene = list(xaxis = list(title = 'Disease Severity Score (x1)'),
        yaxis = list(title = 'Social Determinants Score (x2)'),
        zaxis = list(title = 'Recurrence Biomarker (y)'))
        )
```

Linear regression

```{r}
m <- lm(y ~ x1 + x2, data = df)
xy.grid <- expand.grid(x.grid, y.grid)
names(xy.grid) <- c("x1", "x2")
xy.grid$yhat <- predict(m, xy.grid)
p <- ggplot(df) + 
  geom_point(aes(x = x1, y = x2, colour = y, fill = y), pch = 21) + 
  geom_point(aes(x = x1, y = x2, colour = yhat), alpha = 0.8, data = xy.grid, size = 0.1) + 
  theme_minimal() + 
  xlab("Disease Severity Score (x1)") + 
  ylab("Social Determinants Score (x2)") + theme(axis.text = element_blank()) + 
  scale_colour_gradient(name = "Recurrence\nBiomarker (ng/dL)", low = "#00bfc4", high = "#f8766d") + 
  scale_fill_gradient(name = "Recurrence\nBiomarker (ng/dL)", low = "#00bfc4", high = "#f8766d") + 
  theme(legend.position = "none", panel.grid.major = element_blank(), panel.grid.minor = element_blank())
ggsave(p, filename = "../img/esl-reg-linear.png", height=4, width=4, units="in", dpi=300)
```

KNN with K=15

```{r}
xy.grid <- expand.grid(x.grid, y.grid)
names(xy.grid) <- c("x1", "x2")
m <- knn(df[,1:2], xy.grid, df[,3], k=15, prob=TRUE)
xy.grid$yhat <- as.numeric(as.character(m))
p <- ggplot(df) + 
  geom_point(aes(x = x1, y = x2, colour = y, fill = y), pch = 21) + 
  geom_point(aes(x = x1, y = x2, colour = yhat), alpha = 0.8, data = xy.grid, size = 0.1) + 
  theme_minimal() + 
  xlab("Disease Severity Score (x1)") + 
  ylab("Social Determinants Score (x2)") + theme(axis.text = element_blank()) + 
  scale_colour_gradient(name = "Recurrence\nBiomarker (ng/dL)", low = "#00bfc4", high = "#f8766d") + 
  scale_fill_gradient(name = "Recurrence\nBiomarker (ng/dL)", low = "#00bfc4", high = "#f8766d") + 
  theme(legend.position = "none", panel.grid.major = element_blank(), panel.grid.minor = element_blank())
ggsave(p, filename = "../img/esl-reg-knn-15.png", height=4, width=4, units="in", dpi=300)
```

Decision tree

```{r}
xy.grid <- expand.grid(x.grid, y.grid)
names(xy.grid) <- c("x1", "x2")
m <- rpart(y ~ x1 + x2, data = df)
xy.grid$yhat <- predict(m, xy.grid)
p <- ggplot(df) + 
  geom_point(aes(x = x1, y = x2, colour = y, fill = y), pch = 21) + 
  geom_point(aes(x = x1, y = x2, colour = yhat), alpha = 0.8, data = xy.grid, size = 0.1) + 
  theme_minimal() + 
  xlab("Disease Severity Score (x1)") + 
  ylab("Social Determinants Score (x2)") + theme(axis.text = element_blank()) + 
  scale_colour_gradient(name = "Recurrence\nBiomarker (ng/dL)", low = "#00bfc4", high = "#f8766d") + 
  scale_fill_gradient(name = "Recurrence\nBiomarker (ng/dL)", low = "#00bfc4", high = "#f8766d") + 
  theme(legend.position = "none", panel.grid.major = element_blank(), panel.grid.minor = element_blank())
ggsave(p, filename = "../img/esl-reg-decision-tree.png", height=4, width=4, units="in", dpi=300)
```


